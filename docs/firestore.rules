/**
 * @file Firestore Security Rules for Goal Stack application.
 *
 * @core_philosophy This ruleset implements a combination of ownership-based access control for user-specific data and role-based access control for admin-managed content. Public read access is granted to some collections (e.g., competitions, teams, matches, news).
 *
 * @data_structure
 * - `/users/{userId}`: Stores individual user profiles, accessible only by the user themselves.
 * - `/competitions/{competitionId}`: Stores competition data, publicly readable but admin-manageable.
 * - `/teams/{teamId}`: Stores team data, publicly readable but admin-manageable.
 * - `/matches/{matchId}`: Stores match data, publicly readable.
 * - `/news/{newsId}`: Stores news articles, publicly readable but admin-manageable.
 * - `/admins/{adminId}`:  Indicates admin status; existence of a document grants admin privileges.
 * - `/users/{userId}/favorites`: Stores user's favorite teams and competitions; accessible only by the user themselves.
 * - `/topCompetitions/{competitionId}`: Stores top competitions marked by admins. Publicly readable, but only admins can create/update/delete.
 * - `/topTeams/{teamId}`: Stores top teams marked by admins. Publicly readable, but only admins can create/update/delete.
 * - `/leagueCustomizations/{leagueId}`: Stores custom names for leagues set by admins. Only admins can create/update/delete.
 * - `/teamCustomizations/{teamId}`: Stores custom names for teams set by admins. Only admins can create/update/delete.
 * - `/playerCustomizations/{playerId}`: Stores custom names for players set by admins. Only admins can create/update/delete.
 * - `/matchCustomizations/{fixtureId}`: Stores custom status for matches set by admins. Only admins can create/update/delete.
 * - `/continentCustomizations/{continentId}`: Stores custom names for continents set by admins. Only admins can create/update/delete.
 * - `/countryCustomizations/{countryId}`: Stores custom names for countries set by admins. Only admins can create/update/delete.
 * - `/pinnedIraqiMatches/{matchId}`: Stores the details of a pinned Iraqi match, managed by an admin. Only admins can create/update/delete.
 *
 * @key_security_decisions
 * - User data is strictly private, accessible only to the authenticated user.
 * - Public data (competitions, teams, matches, news, predictions) is publicly readable but admin-managed where appropriate.
 * - Admin privileges are determined by the existence of a document in `/admins/{adminId}`.
 * - List operations are allowed only where explicitly permitted.
 *
 * @denormalization_for_authorization Admin status is determined by the presence of a document in `/admins/{adminId}`, avoiding the need to store admin roles within user documents or make complex queries.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ====== Helper Functions ======
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ====== Admin Override (Full Access) ======
    match /{path=**} {
      allow read, write: if isAdmin();
    }

    // ====== Public Data (Read for All, Write for Admin Only) ======
    match /{collectionName}/{docId} {
      allow read: if collectionName in [
        'news',
        'competitions',
        'teams',
        'managedCompetitions',
        'iraqiLeagueTopScorers',
        'pinnedIraqiMatches',
        'leagueCustomizations',
        'teamCustomizations',
        'playerCustomizations',
        'coachCustomizations',
        'continentCustomizations',
        'countryCustomizations',
        'matchCustomizations'
      ];
      allow write: if false; // Admin write is covered by the admin override rule above
    }

    // ====== Users Collection ======
    match /users/{userId} {
      // Create user profile
      allow create: if isSignedIn() && isOwner(userId);

      // Read and update own profile
      allow read, update: if isOwner(userId);

      // ---- Favorites Subcollection ----
      match /favorites/{favId} {
        allow read, write: if isOwner(userId) && favId == "data";
      }
    }

    // ====== Predictions System ======
    match /predictions/{fixtureId} {
      // Everyone can read the list of available matches for prediction
      allow list, read: if true;

      // Only admin can create, update, or delete a prediction fixture
      allow write: if isAdmin();

      // ---- User Predictions Subcollection ----
      match /userPredictions/{userId} {
        // User can read their own prediction
        allow read: if isOwner(userId);

        // User can create or update their prediction ONLY before the match starts
        allow create, update: if isOwner(userId);
        
        // Deletion is only for admins (covered by admin override)
        allow delete: if false;
      }
    }

    // ====== Leaderboard ======
    match /leaderboard/{docId} {
      // Everyone can read the leaderboard
      allow read: if true;

      // Only admin can write to the leaderboard
      allow write: if isAdmin();
    }
  }
}
