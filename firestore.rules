
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ====== Helper Functions ======
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ====== Admin Override (Full Access) ======
    match /{path=**} {
      allow read, write: if isAdmin();
    }

    // ====== Public Data (Read for All, Write for Admin Only) ======
    match /{collectionName}/{docId} {
      allow read: if collectionName in [
        'news',
        'competitions',
        'teams',
        'managedCompetitions',
        'iraqiLeagueTopScorers',
        'pinnedIraqiMatches',
        'leagueCustomizations',
        'teamCustomizations',
        'playerCustomizations',
        'coachCustomizations',
        'continentCustomizations',
        'countryCustomizations',
        'matchCustomizations'
      ];
      allow write: if false; // Admin write is covered by the admin override rule above
    }

    // ====== Users Collection ======
    match /users/{userId} {
      // Create user profile
      allow create: if isSignedIn() && isOwner(userId);

      // Read and update own profile
      allow read, update: if isOwner(userId);

      // ---- Favorites Subcollection ----
      match /favorites/{favId} {
        allow read, write: if isOwner(userId) && favId == "data";
      }
    }

    // ====== Predictions System ======
    match /predictions/{fixtureId} {
      // (THIS IS THE FIX) Everyone can read the list of available matches for prediction
      allow list, read: if true;

      // Only admin can create, update, or delete a prediction fixture
      allow write: if isAdmin();

      // ---- User Predictions Subcollection ----
      match /userPredictions/{userId} {
        // User can read their own prediction
        allow read: if isOwner(userId);

        // User can create or update their prediction ONLY before the match starts
        allow create, update: if isOwner(userId);
        
        // Deletion is only for admins (covered by admin override)
        allow delete: if false;
      }
    }

    // ====== Leaderboard ======
    match /leaderboard/{docId} {
      // Everyone can read the leaderboard
      allow read: if true;

      // Only admin can write to the leaderboard
      allow write: if isAdmin();
    }
  }
}
